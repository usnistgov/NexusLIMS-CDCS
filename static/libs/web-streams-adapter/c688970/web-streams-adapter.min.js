(function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):(e=e||self,t(e.WebStreamsAdapter={}))})(this,function(e){"use strict";function t(e,t){function r(){this.constructor=e}W(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}function r(e){if(!e)throw new TypeError("Assertion failed")}function n(){}function i(e){return"object"==typeof e&&null!==e||"function"==typeof e}function o(e){if("function"!=typeof e)return!1;var t=!1;try{new e({start:function(){t=!0}})}catch(e){}return t}function a(e){return!!i(e)&&"function"==typeof e.getReader}function s(e){return!!o(e)&&!!a(new e)}function u(e){return!!i(e)&&"function"==typeof e.getWriter}function d(e){return!!o(e)&&!!u(new e)}function c(e){return!!i(e)&&(!!a(e.readable)&&!!u(e.writable))}function h(e){return!!o(e)&&!!c(new e)}function f(e){try{var t=e.getReader({mode:"byob"});return t.releaseLock(),!0}catch(e){return!1}}function l(e){try{return new e({type:"bytes"}),!0}catch(e){return!1}}function _(e){r(s(e));var t=l(e);return function(r,n){var i=(void 0===n?{}:n).type;if(i=y(i),"bytes"!==i||t||(i=void 0),r.constructor===e&&("bytes"!==i||f(r)))return r;var o=p(r,{type:i});return new e(o)}}function p(e,t){var n,i=(void 0===t?{}:t).type;return r(a(e)),r(!1===e.locked),i=y(i),n="bytes"===i?new C(e):new P(e),n}function y(e){var t=String(e);if("bytes"===t)return t;if(void 0===e)return e;throw new RangeError("Invalid type is specified")}function v(e){return new Uint8Array(e.buffer,e.byteOffset,e.byteLength)}function g(e,t){var r=v(e),n=v(t);n.set(r,0)}function b(e){return r(d(e)),function(t){if(t.constructor===e)return t;var r=R(t);return new e(r)}}function R(e){r(u(e)),r(!1===e.locked);var t=e.getWriter();return new E(t)}function m(e){return r(h(e)),function(t){if(t.constructor===e)return t;var r=w(t);return new e(r)}}function w(e){r(c(e));var t=e.readable,n=e.writable;r(!1===t.locked),r(!1===n.locked);var i,o=t.getReader();try{i=n.getWriter()}catch(e){throw o.releaseLock(),e}return new j(o,i)}var W=function(e,t){return W=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])},W(e,t)},S=function(){function e(e){this._underlyingReader=void 0,this._readerMode=void 0,this._readableStreamController=void 0,this._pendingRead=void 0,this._underlyingStream=e,this._attachDefaultReader()}return e.prototype.start=function(e){this._readableStreamController=e},e.prototype.cancel=function(e){return r(void 0!==this._underlyingReader),this._underlyingReader.cancel(e)},e.prototype._attachDefaultReader=function(){if("default"!==this._readerMode){this._detachReader();var e=this._underlyingStream.getReader();this._readerMode="default",this._attachReader(e)}},e.prototype._attachReader=function(e){var t=this;r(void 0===this._underlyingReader),this._underlyingReader=e;var i=this._underlyingReader.closed;i&&i.then(function(){return t._finishPendingRead()}).then(function(){e===t._underlyingReader&&t._readableStreamController.close()},function(r){e===t._underlyingReader&&t._readableStreamController.error(r)}).catch(n)},e.prototype._detachReader=function(){void 0!==this._underlyingReader&&(this._underlyingReader.releaseLock(),this._underlyingReader=void 0,this._readerMode=void 0)},e.prototype._pullWithDefaultReader=function(){var e=this;this._attachDefaultReader();var t=this._underlyingReader.read().then(function(t){var r=e._readableStreamController;t.done?e._tryClose():r.enqueue(t.value)});return this._setPendingRead(t),t},e.prototype._tryClose=function(){try{this._readableStreamController.close()}catch(e){}},e.prototype._setPendingRead=function(e){var t,r=this,n=function(){r._pendingRead===t&&(r._pendingRead=void 0)};this._pendingRead=t=e.then(n,n)},e.prototype._finishPendingRead=function(){var e=this;if(this._pendingRead){var t=function(){return e._finishPendingRead()};return this._pendingRead.then(t,t)}},e}(),P=function(e){function r(){return null!==e&&e.apply(this,arguments)||this}return t(r,e),r.prototype.pull=function(){return this._pullWithDefaultReader()},r}(S),C=function(e){function n(t){var r=this,n=f(t);return r=e.call(this,t)||this,r._supportsByob=n,r}return t(n,e),Object.defineProperty(n.prototype,"type",{get:function(){return"bytes"},enumerable:!0,configurable:!0}),n.prototype._attachByobReader=function(){if("byob"!==this._readerMode){r(this._supportsByob),this._detachReader();var e=this._underlyingStream.getReader({mode:"byob"});this._readerMode="byob",this._attachReader(e)}},n.prototype.pull=function(){if(this._supportsByob){var e=this._readableStreamController.byobRequest;if(void 0!==e)return this._pullWithByobRequest(e)}return this._pullWithDefaultReader()},n.prototype._pullWithByobRequest=function(e){var t=this;this._attachByobReader();var r=new Uint8Array(e.view.byteLength),n=this._underlyingReader.read(r).then(function(r){t._readableStreamController;r.done?(t._tryClose(),e.respond(0)):(g(r.value,e.view),e.respond(r.value.byteLength))});return this._setPendingRead(n),n},n}(S),E=function(){function e(e){var t=this;this._writableStreamController=void 0,this._pendingWrite=void 0,this._state="writable",this._storedError=void 0,this._underlyingWriter=e,this._errorPromise=new Promise(function(e,r){t._errorPromiseReject=r}),this._errorPromise.catch(n)}return e.prototype.start=function(e){var t=this;this._writableStreamController=e,this._underlyingWriter.closed.then(function(){t._state="closed"}).catch(function(e){return t._finishErroring(e)})},e.prototype.write=function(e){var t=this,r=this._underlyingWriter;if(null===r.desiredSize)return r.ready;var n=r.write(e);n.catch(function(e){return t._finishErroring(e)}),r.ready.catch(function(e){return t._startErroring(e)});var i=Promise.race([n,this._errorPromise]);return this._setPendingWrite(i),i},e.prototype.close=function(){var e=this;return void 0===this._pendingWrite?this._underlyingWriter.close():this._finishPendingWrite().then(function(){return e.close()})},e.prototype.abort=function(e){if("errored"!==this._state){var t=this._underlyingWriter;return t.abort(e)}},e.prototype._setPendingWrite=function(e){var t,r=this,n=function(){r._pendingWrite===t&&(r._pendingWrite=void 0)};this._pendingWrite=t=e.then(n,n)},e.prototype._finishPendingWrite=function(){var e=this;if(void 0===this._pendingWrite)return Promise.resolve();var t=function(){return e._finishPendingWrite()};return this._pendingWrite.then(t,t)},e.prototype._startErroring=function(e){var t=this;if("writable"===this._state){this._state="erroring",this._storedError=e;var r=function(){return t._finishErroring(e)};void 0===this._pendingWrite?r():this._finishPendingWrite().then(r,r),this._writableStreamController.error(e)}},e.prototype._finishErroring=function(e){"writable"===this._state&&this._startErroring(e),"erroring"===this._state&&(this._state="errored",this._errorPromiseReject(this._storedError))},e}(),j=function(){function e(e,t){var r=this;this._transformStreamController=void 0,this._onRead=function(e){if(!e.done)return r._transformStreamController.enqueue(e.value),r._reader.read().then(r._onRead)},this._onError=function(e){r._flushReject(e),r._transformStreamController.error(e),r._reader.cancel(e).catch(n),r._writer.abort(e).catch(n)},this._onTerminate=function(){r._flushResolve(),r._transformStreamController.terminate();var e=new TypeError("TransformStream terminated");r._writer.abort(e).catch(n)},this._reader=e,this._writer=t,this._flushPromise=new Promise(function(e,t){r._flushResolve=e,r._flushReject=t})}return e.prototype.start=function(e){this._transformStreamController=e,this._reader.read().then(this._onRead).then(this._onTerminate,this._onError);var t=this._reader.closed;t&&t.then(this._onTerminate,this._onError)},e.prototype.transform=function(e){return this._writer.write(e)},e.prototype.flush=function(){var e=this;return this._writer.close().then(function(){return e._flushPromise})},e}();e.createReadableStreamWrapper=_,e.createTransformStreamWrapper=m,e.createWrappingReadableSource=p,e.createWrappingTransformer=w,e.createWrappingWritableSink=R,e.createWritableStreamWrapper=b,Object.defineProperty(e,"__esModule",{value:!0})});